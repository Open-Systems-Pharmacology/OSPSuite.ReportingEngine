---
title: "Word Report"
resource_files:
  - figures
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{How to work with word reports}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r vignette setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
source(system.file("extdata", "vignette-helpers.R", package = "ospsuite.reportingengine"))
```

```{r setup}
require(ospsuite.reportingengine)
```


For each workflow, the Reporting Engine exports a [markdown](https://www.markdownguide.org/) version of your report (*.md*).
A Word version (*.docx*) - converted from the markdown - is also exported by default via the logical field [`createWordReport`](../reference/Workflow.html#public-fields).

This article aims at documenting available options and settings that work with the conversion of the markdown report into its word version.

## Installing Pandoc

[**Pandoc**](https://pandoc.org/) is the software responsible for the conversion of the markdown report into its word version.
As a consequence, the installation of **pandoc** is required for this feature.
If you need to install **pandoc**, please follow the instructions provided on the [Github](https://github.com/Open-Systems-Pharmacology/OSPSuite.ReportingEngine/wiki/Installing-pandoc).

<!--- TODO: the wiki is currently empty and needs to have instructions for the user -->

## Word Conversion Template

The *Word Conversion Template* is a word document used by **pandoc** that provides a reference styling of your word document.
The location of the template file needs to be indicated to workflow field [`wordConversionTemplate`](../reference/Workflow.html#public-fields). 

<details><summary>MS Word view of *Word Conversion Template*</summary>

```{r, include = FALSE}
# After running each vignette, their output is cleared when using devtools::check()
# However, the content of "figures/" directory is required for docs/articles that display vignettes as a webpage
# Thus, the file is temporarily copied to "figures/"
dir.create("figures", showWarnings = FALSE)
file.copy(
  from = system.file("extdata", "reference-docx.png", package = "ospsuite.reportingengine"),
  to = "figures"
) 
```

![](figures/reference-docx.png){width="90%"}

</details>


### How to get the template

Workflows use the following default template which can be downloaded via [Github](https://github.com/Open-Systems-Pharmacology/OSPSuite.ReportingEngine/blob/develop/inst/extdata/reference.docx)

Otherwise you can copy the file directly from its location within the package as illustrated below.

```r
wordConversionTemplate <- system.file("extdata", "reference.docx", package = "ospsuite.reportingengine")
file.copy(from = wordConversionTemplate, to = getwd())
```

### How to update the template

As indicated in [pandoc documentation](https://pandoc.org/MANUAL.html#options-affecting-specific-writers),
*Paragraph styles*, *Character styles* and *Table style* items can be modified in the *Word Conversion Template*.

In the following bullet points, tutorial videos shows how to update such style items.

<details><summary><strong>Paragraph and Character styles</strong></summary>

```{r, include = FALSE}
file.copy(
  from = system.file("extdata", "paragraph-styles-reference-doc.mp4", package = "ospsuite.reportingengine"),
  to = "figures"
) 
```

![](figures/paragraph-styles-reference-doc.mp4){width="90%"}

</details>

<details><summary><strong>Table style</strong></summary>

Note that only one Table style named [**Table**](https://github.com/jgm/pandoc/issues/7746) is used by pandoc for styling the converted tables.

Note that the font in the table needs to be defined by updating the character style named [*Compact*](https://github.com/Open-Systems-Pharmacology/OSPSuite.ReportingEngine/issues/857).

**Limitations**: As indicated in issue [#857](https://github.com/Open-Systems-Pharmacology/OSPSuite.ReportingEngine/issues/857),
styling does not account for text alignment/justification within the table.

```{r, include = FALSE}
file.copy(
  from = system.file("extdata", "table-style-reference-doc.mp4", package = "ospsuite.reportingengine"),
  to = "figures"
) 
```

![](figures/table-style-reference-doc.mp4){width="90%"}

</details>


## Some Pandoc Tips

Before rendering the word report, an intermediate markdown report dedicated to the conversion is created (`"report-word.md"`).
Then, the intermediate report and the configuration options (`"report-configuration.txt"`) are provided to **pandoc** using the `{knitr}` package as illustrated below.

```r
knitr::pandoc(input = "report-word.md", format = "docx", config = "report-configuration.txt")
```

The content of the configuration options (`"report-configuration.txt"`) is described below:

```yaml
embed-resources:
standalone:
wrap: none
toc:
from: markdown+tex_math_dollars+superscript+subscript+raw_attribute
reference-doc: <wordConversionTemplate>
resource-path: <workflowFolder>
```

### Include superscript and subscript *html* tags

The options `+superscript` and `+subscript` allows [pandoc](https://pandoc.org/MANUAL.html#superscripts-and-subscripts) 
to translate `^...^` and `~...~` into superscript and subscript within the word document.

Since, the Reporting Engine internally translates the *html* tags **`<sup>...</sup>`** and **`<sub>...</sub>`** of the markdown report into `^...^` and `~...~`.
**Users can directly include the *html* tags into sub parts of their markdown reports**.

### Include LateX equations

The option `+tex_math_dollars` allows [pandoc](https://pandoc.org/MANUAL.html#extension-tex_math_dollars) 
to translate mathematical equations defined in [*LateX*](https://en.wikibooks.org/wiki/LaTeX/Mathematics).

<!--- Link to LateX wikibook that provides lists of symbols, letters and operators -->

Unfortunately, the translation works only to some extent as some formatting options cannot be translated (e.g. `\Huge` - [#1029](https://github.com/Open-Systems-Pharmacology/OSPSuite.ReportingEngine/issues/1029)).

Inline equations can be defined using within `$..$` while equation block within `$$...$$` as illustrated below.

```latex
$$
A \rightarrow B \rightarrow C \\
\frac{dA}{dt} = -k_aA  \\
\frac{dB}{dt} = k_aA - k_bB  \\
\frac{dC}{dt} = k_bB - k_cC  \\
$$
```

would render

$$
A \rightarrow B \rightarrow C \\
\frac{dA}{dt} = -k_aA  \\
\frac{dB}{dt} = k_aA - k_bB  \\
\frac{dC}{dt} = k_bB - k_cC
$$

### Include raw openxml

The option `+raw_attribute` allows [pandoc](https://pandoc.org/MANUAL.html#extension-raw_attribute) to leave use raw code block as is.
This option is convenient when including page breaks and bookmarks in your word reports.
Word document use *openxml* 

#### Page Break 

As defined in https://pandoc.org/MANUAL.html#extension-raw_attribute,
Word page breaks can be included by inserting the following code block within the markdown document.


````xml
```{=openxml}
<w:p><w:r><w:br w:type="page"/></w:r></w:p>
```
````

#### Bookmark

Code blocks defining word bookmarks can be inserted in your markdown document.
The example below, inspired from the following [link](https://learn.microsoft.com/en-us/dotnet/api/documentformat.openxml.wordprocessing.bookmarkstart?view=openxml-2.8.1#remarks), 
defines a bookmark named `"my-bookmark"`

````xml
```{=openxml}
<w:p><w:r>
<w:bookmarkStart w:id="my-bookmark" w:name="my-bookmark"/>
<w:bookmarkEnd w:id="my-bookmark"/>
</w:r></w:p>
```
````

#### Page Break and Bookmark

Both a page break and a bookmark can be inserted at the same time by combining the raw code blocks previously defined.

````xml
```{=openxml}
<w:p><w:r><w:br w:type="page"/></w:r><w:r>
<w:bookmarkStart w:id="my-bookmark" w:name="my-bookmark"/>
<w:bookmarkEnd w:id="my-bookmark"/>
</w:r></w:p>
```
````

#### Paragraph alignment/justification

Specific paragraph alignments/justifications can also be defined by including the following raw blocks before the paragraphs.

<details><summary><strong>Left aligned</strong></summary>

````xml
```{=openxml}
<w:pPr>
<w:jc w:val="left"/>
</w:pPr>
```
````

</details>

<details><summary><strong>Centered</strong></summary>

````xml
```{=openxml}
<w:pPr>
<w:jc w:val="center"/>
</w:pPr>
```
````

</details>

<details><summary><strong>Right aligned</strong></summary>

````xml
```{=openxml}
<w:pPr>
<w:jc w:val="right"/>
</w:pPr>
```
````

</details>

<details><summary><strong>Justifed</strong></summary>

````xml
```{=openxml}
<w:pPr>
<w:jc w:val="both"/>
</w:pPr>
```
````
</details>

